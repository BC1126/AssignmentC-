@model PaginatedList<Staff>
@{
    var currentUrl = Context.Request.Path + Context.Request.QueryString;
}

<form asp-action="BatchDeleteStaff" asp-controller="Admin" method="post" id="batchDeleteStaffForm">

    <div class="table-container border">

        <div class="p-3 d-flex justify-content-between align-items-center bg-light border-bottom">
            <div>
                <p class="text-muted mb-0">Showing @Model.Items.Count record(s)</p>
            </div>
            <div>
                <button type="button" class="btn btn-danger btn-sm shadow-sm" onclick="openStaffDeleteModal()">
                    <i class="bi bi-trash"></i> Delete Selected
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;" class="text-center">
                            <input type="checkbox" id="selectAllStaff" class="form-check-input" style="cursor: pointer;" />
                        </th>

                        <th><a href="javascript:void(0)" class="sort-link" data-sort="@ViewData["IdSort"]">ID</a></th>
                        <th><a href="javascript:void(0)" class="sort-link" data-sort="@ViewData["NameSort"]">Name</a></th>
                        <th>Gender</th>
                        <th><a href="javascript:void(0)" class="sort-link" data-sort="@ViewData["EmailSort"]">Email</a></th>
                        <th>Phone</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in Model.Items)
                    {
                        <tr>
                            <td class="text-center align-middle">
                                <input type="checkbox" name="selectedIds" value="@u.UserId" class="form-check-input staff-checkbox" />
                            </td>

                            <td class="align-middle"><strong>@u.UserId</strong></td>
                            <td class="align-middle">@u.Name</td>
                            <td class="align-middle">@u.Gender</td>
                            <td class="align-middle">@u.Email</td>
                            <td class="align-middle">@u.Phone</td>
                            <td class="text-center align-middle">
                                <div class="d-flex justify-content-center gap-2">
                                    <a asp-controller="Admin" asp-action="StaffDetails" asp-route-id="@u.UserId"
                                       class="btn btn-sm btn-info text-white shadow-sm" title="View Details">
                                        <i class="bi bi-eye"></i> Details
                                    </a>

                                    <a asp-controller="Admin" asp-action="AdminEditUser" asp-route-id="@u.UserId"
                                       asp-route-returnUrl="@currentUrl"
                                       class="btn btn-sm btn-warning text-dark shadow-sm" title="Edit User">
                                        <i class="bi bi-pencil-square"></i> Update
                                    </a>

                                    <button type="button" class="btn btn-sm btn-danger shadow-sm"
                                            onclick="openDeleteModal('@u.UserId', '@u.Name')" title="Delete User">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 p-3 border-top">
            <span class="text-muted small">Page @Model.PageIndex of @Model.TotalPages</span>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(Model.PageIndex - 1)">Previous</a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                            <a class="page-link" href="javascript:void(0)" data-page="@i">@i</a>
                        </li>
                    }
                    <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                        <a class="page-link" href="javascript:void(0)" data-page="@(Model.PageIndex + 1)">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</form>

<div class="modal fade" id="staffDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Staff Accounts</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fs-5">Are you sure you want to delete the <strong id="staffSelectedCount">0</strong> selected staff member(s)?</p>
                <p class="text-danger small mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitStaffDelete()">Yes, Delete All</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Select All Logic (Unique to Staff)
    var selectAllStaff = document.getElementById('selectAllStaff');
    if(selectAllStaff) {
        selectAllStaff.addEventListener('change', function() {
            var checkboxes = document.querySelectorAll('.staff-checkbox');
            for (var checkbox of checkboxes) {
                checkbox.checked = this.checked;
            }
        });
    }

    // 2. Open Modal Logic
    function openStaffDeleteModal() {
        var checkedCount = document.querySelectorAll('.staff-checkbox:checked').length;

        if (checkedCount === 0) {
            alert("Please select at least one staff member to delete.");
            return;
        }

        document.getElementById('staffSelectedCount').innerText = checkedCount;
        var myModal = new bootstrap.Modal(document.getElementById('staffDeleteModal'));
        myModal.show();
    }

    // 3. Submit Logic
    function submitStaffDelete() {
        document.getElementById('batchDeleteStaffForm').submit();
    }
</script>