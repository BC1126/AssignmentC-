@model EditProfileVM
@{
    ViewData["Title"] = "Edit Profile";
}

<section id="edit-profile" class="p_3" style="padding-top: 3rem; padding-bottom: 3rem;">
    <div class="container-xl">

        @* Header *@
        <div class="row justify-content-center mb-4">
            <div class="col-md-8 text-center">
                <h2 class="fw-bold mb-3" style="font-family: 'Georgia', serif; color: #333; font-size: 2.5rem;">
                    Edit Your Profile
                </h2>
                <div style="border-bottom: 1px solid #e0e0e0; width: 100%; margin: 0 auto;"></div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <form asp-action="EditProfile" asp-controller="User" method="post" enctype="multipart/form-data">

                    <div class="login_1m p-5 bg-white shadow-sm" style="border-radius: 8px; border: 1px solid #f0f0f0;">

                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="Role" />
                        <input type="hidden" asp-for="CurrentPhotoUrl" />

                        @* ======================================================= *@
                        @* LOGIC: Check Role to decide if Photo is Editable        *@
                        @* ======================================================= *@
                        @if (User.IsInRole("Admin") || User.IsInRole("Staff"))
                        {
                            <div class="text-center mb-4">
                                <img src="@Model.CurrentPhotoUrl"
                                     alt="Profile Photo"
                                     class="rounded-circle img-thumbnail shadow-sm"
                                     style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #ccc; opacity: 0.9;"
                                     onerror="this.src='/img/default.jpg';" />

                                <p class="text-muted small mt-2">
                                    <i class="fa fa-lock"></i> Photo cannot be changed for @(User.IsInRole("Admin") ? "Admins" : "Staff").
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="text-center mb-4">
                                <div id="photoUploadArea" style="cursor: pointer; display: inline-block; position: relative;" title="Click to change photo">

                                    <input asp-for="NewPhoto" id="profilePhotoInput" type="file"
                                           accept="image/*" style="display: none;" />

                                    <img id="profilePhotoPreview"
                                         src="@Model.CurrentPhotoUrl"
                                         alt="Profile Photo"
                                         class="rounded-circle img-thumbnail shadow-sm"
                                         style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #ffc107;"
                                         onerror="this.src='/img/default.jpg';" />

                                    <div style="position: absolute; bottom: 0; right: 10px; background: #ffc107; border-radius: 50%; padding: 5px 8px;">
                                        <i class="fa fa-camera text-dark"></i>
                                    </div>
                                </div>
                                <span asp-validation-for="NewPhoto" class="text-danger d-block mt-2"></span>
                                <p class="text-muted small mt-2">Click the photo to upload a new one</p>
                            </div>
                        }
                        @* ======================================================= *@

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Name" class="form-label fw-bold">Full Name</label>
                                <input asp-for="Name" class="form-control" />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label fw-bold">Phone Number</label>
                                <input asp-for="Phone" class="form-control" />
                                <span asp-validation-for="Phone" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Gender" class="form-label fw-bold">Gender</label>
                                <select asp-for="Gender" class="form-select">
                                    <option value="">-- Select Gender --</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label fw-bold">Email Address</label>
                                <input asp-for="Email" class="form-control" readonly style="background-color: #e9ecef;" />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mt-4 text-center d-flex justify-content-center gap-3">
                            <a asp-action="Profile" class="btn btn-outline-secondary px-4 shadow-sm">
                                <i class="fa fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-warning px-5 shadow-sm">
                                <i class="fa fa-save"></i> Save Changes
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // These elements might not exist if in "Read Only" mode
            const input = document.getElementById('profilePhotoInput');
            const preview = document.getElementById('profilePhotoPreview');
            const uploadArea = document.getElementById('photoUploadArea');
            const defaultPhotoUrl = '@Model.CurrentPhotoUrl';

            // Only attach events if the elements exist (i.e., user is a Member)
            if (uploadArea) {
                uploadArea.addEventListener('click', function() {
                    if (input) input.click();
                });
            }

            if (input) {
                input.addEventListener('change', function(event) {
                    if (input.files && input.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            if (preview) preview.src = e.target.result;
                        }
                        reader.readAsDataURL(input.files[0]);
                    } else {
                        if (preview) preview.src = defaultPhotoUrl;
                    }
                });
            }
        });
    </script>
}