@model AssignmentC_.Models.ShowTimeManageVM

@{
    ViewData["Title"] = "Manage ShowTimes";
}


<br />
<br />
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h4>ShowTime Management</h4>

        <!-- Filters -->
        <form id="filterForm" method="get" asp-action="ShowTimeManage" class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label">Outlet</label>
                <select name="outletId" id="outletSelect" class="form-select">
                    <option value="">-- All Outlets --</option>
                    @foreach (var outlet in Model.Outlets)
                    {
                        <option value="@outlet.OutletId" selected="@(Model.OutletId == outlet.OutletId)">
                            @outlet.Name (@outlet.City)
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Hall</label>
                <select name="hallId" id="hallSelect" class="form-select" disabled>
                    <option value="">-- Select Hall --</option>
                </select>

            </div>

            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date"
                       name="date"
                       id="dateSelect"
                       class="form-control" />
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <a asp-action="Manage" class="btn btn-success w-100">Add New ShowTime</a>
            </div>
        </form>

        <!-- ShowTime Table -->
        <div id="showtimeTable">
            @if (Model.ExistingShowTimes == null || !Model.ExistingShowTimes.Any())
            {
                <div class="alert alert-info">
                    No showtimes scheduled for the selected filters.
                </div>
            }
            else
            {
                <!-- Container that never gets replaced -->
                <form id="batchDeleteForm"
                      asp-action="BatchDelete"
                      method="post"
                      onsubmit="return confirm('Delete selected showtimes?');">

                    <input type="hidden" name="outletId" id="bdOutlet" />
                    <input type="hidden" name="hallId" id="bdHall" />
                    <input type="hidden" name="date" id="bdDate" />

                    @Html.AntiForgeryToken()

                    <!-- ONLY THIS gets replaced by AJAX -->
                    <div id="showtimeTableContainer">
                        @Html.Partial("_ShowTimeTable", Model.ExistingShowTimes)
                    </div>

                    <div class="mt-3">
                        <button type="submit"
                                class="btn btn-danger"
                                disabled
                                id="deleteSelectedBtn">
                            Delete Selected
                        </button>
                    </div>

                </form>



            }
        </div>

    </div>
</div>


@section Scripts {
    <script>
        // 🔥 MUST be global (outside $(function))
         function loadShowTimes() {
            $.get('@Url.Action("FilterShowTimes")',
                $('#filterForm').serialize(),
                function (data) {
                    $('#showtimeTableContainer').html(data);

                    $('#deleteSelectedBtn').prop('disabled', true);
                    $('#checkAll').prop('checked', false);
                }
            );
        }


        $(function () {

        $('#batchDeleteForm').on('submit', function () {
            $('#bdOutlet').val($('#outletSelect').val());
            $('#bdHall').val($('#hallSelect').val());
            $('#bdDate').val($('#dateSelect').val());
        });


            // Outlet change
            $('#outletSelect').on('change', function () {
                let outletId = $(this).val();

                $('#hallSelect')
                    .prop('disabled', true)
                    .html('<option value="">Loading...</option>');

                if (!outletId) {
                    $('#hallSelect').html('<option value="">-- Select Hall --</option>');
                    loadShowTimes();
                    return;
                }

                $.get('@Url.Action("GetHalls")', { outletId }, function (data) {
                    let options = '<option value="">-- Select Hall --</option>';
                    $.each(data, function (i, hall) {
                        options += `<option value="${hall.hallId}">${hall.name}</option>`;
                    });

                    $('#hallSelect').html(options).prop('disabled', false);
                    loadShowTimes();
                });
            });

            // Hall or Date change
            $('#hallSelect, #dateSelect').on('change', loadShowTimes);

            // Row checkbox
            $(document).on('change', '.row-check', function () {
                $('#deleteSelectedBtn').prop(
                    'disabled',
                    $('.row-check:checked').length === 0
                );
            });

            // Check all
            $(document).on('change', '#checkAll', function () {
                $('.row-check').prop('checked', this.checked);
                $('#deleteSelectedBtn').prop('disabled', !this.checked);
            });

        });

         // ===============================
        // SINGLE DELETE (AJAX)
        // ===============================
        $(document).on('click', '.single-delete', function () {
            if (!confirm('Are you sure you want to delete this showtime?'))
                return;

            let id = $(this).data('id');

            $.post('@Url.Action("DeleteShowTime")', {
                id: id,
                __RequestVerificationToken:
                    $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function (res) {
                if (res.success) {
                    alert(res.message);   // ✅ message replaces TempData
                    loadShowTimes();      // ✅ keep current filters
                } else {
                    alert(res.message || 'Delete failed');
                }
            })
            .fail(function (xhr) {
                alert('Delete failed: ' + xhr.status);
            });
        });

    </script>

}
