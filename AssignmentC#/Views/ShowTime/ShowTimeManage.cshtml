@model AssignmentC_.Models.ShowTimeManageVM

@{
    ViewData["Title"] = "Manage ShowTimes";
}


<br />
<br />
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h4>ShowTime Management</h4>

        <!-- Filters -->
        <form id="filterForm" method="get" asp-action="ShowTimeManage" class="row g-3 mb-3">

            <input type="hidden" name="sort" id="currentSort" value="@ViewBag.Sort" />
            <input type="hidden" name="dir" id="currentDir" value="@ViewBag.Dir" />

            <div class="col-md-3">
                <label class="form-label">Outlet</label>
                <select name="outletId" id="outletSelect" class="form-select">
                    <option value="">-- All Outlets --</option>
                    @foreach (var outlet in Model.Outlets)
                    {
                        <option value="@outlet.OutletId" selected="@(Model.OutletId == outlet.OutletId)">
                            @outlet.Name (@outlet.City)
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Hall</label>
                <select name="hallId" id="hallSelect" class="form-select" disabled>
                    <option value="">-- All --</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Movie</label>
                <select name="movieId" id="movieSelect" class="form-select">
                    <option value="">-- All Movies --</option>
                    @foreach (var m in Model.Movies)
                    {
                        <option value="@m.MovieId" selected="@(ViewBag.SelectedMovieId == m.MovieId)">
                            @m.Title
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Date</label>
                <input type="date" name="date" id="dateSelect" class="form-control" />
            </div>

            <div class="col-md-3">
                <div class="d-grid gap-2">

                    <button type="submit"
                            asp-action="ExportShowTimes"
                            class="btn btn-primary"
                            title="Download Schedule CSV">
                        <i class="fa fa-download"></i> Export
                    </button>

                    <a asp-action="Manage" class="btn btn-success">
                        <i class="fa fa-plus"></i> Add New
                    </a>

                </div>
            </div>
        </form>
        <!-- ShowTime Table -->
        <div id="showtimeTable">
            @if (Model.ExistingShowTimes == null || !Model.ExistingShowTimes.Any())
            {
                <div class="alert alert-info">
                    No showtimes scheduled for the selected filters.
                </div>
            }
            else
            {
                <!-- Container that never gets replaced -->
                <form id="batchDeleteForm"
                      asp-action="BatchDelete"
                      method="post"
                      onsubmit="return confirm('Delete selected showtimes?');">

                    <input type="hidden" name="outletId" id="bdOutlet" />
                    <input type="hidden" name="hallId" id="bdHall" />
                    <input type="hidden" name="date" id="bdDate" />

                    @Html.AntiForgeryToken()

                    <!-- ONLY THIS gets replaced by AJAX -->
                    <div id="showtimeTableContainer">
                        @Html.Partial("_ShowTimeTable", Model.ExistingShowTimes)
                    </div>

                    <div class="mt-3">
                        <button type="submit"
                                class="btn btn-danger"
                                disabled
                                id="deleteSelectedBtn">
                            Delete Selected
                        </button>
                    </div>

                </form>



            }
        </div>

    </div>
</div>


@section Scripts {
    <script>
        // Store the current page globally so we can stay on the same page after deleting
        var currentPage = 1;

        // 🔥 Updated function: Accepts 'page' parameter (defaults to 1)
        function loadShowTimes(page = 1) {
            currentPage = page; // Update global tracker

            // 1. Get existing filter data
            let formData = $('#filterForm').serialize();

            // 2. Append the page number manually
            formData += '&page=' + page;

            $.get('@Url.Action("FilterShowTimes")',
                formData,
                function (data) {
                    $('#showtimeTableContainer').html(data);

                    // Reset UI states
                    $('#deleteSelectedBtn').prop('disabled', true);
                    $('#checkAll').prop('checked', false);
                }
            );
        }

        function sortShowTimes(column) {
            let currentSort = $('#currentSort').val();
            let currentDir = $('#currentDir').val();

            // If clicking the same column, toggle direction
            if (currentSort === column) {
                $('#currentDir').val(currentDir === 'asc' ? 'des' : 'asc');
            } else {
                // If clicking a new column, reset to ascending
                $('#currentSort').val(column);
                $('#currentDir').val('asc');
            }
            loadShowTimes(1);
        }

        $(function () {
            // Load initial data (Page 1)
            loadShowTimes(1);

            // Handle Batch Delete Form Submission
            $('#batchDeleteForm').on('submit', function () {
                $('#bdOutlet').val($('#outletSelect').val());
                $('#bdHall').val($('#hallSelect').val());
                $('#bdDate').val($('#dateSelect').val());
            });

            // Outlet change
            $('#outletSelect').on('change', function () {
                let outletId = $(this).val();

                $('#hallSelect')
                    .prop('disabled', true)
                    .html('<option value="">Loading...</option>');

                if (!outletId) {
                    $('#hallSelect').html('<option value="">-- Select Hall --</option>');
                    loadShowTimes(1); // Reset to Page 1
                    return;
                }

                $.get('@Url.Action("GetHalls")', { outletId }, function (data) {
                    let options = '<option value="">-- Select Hall --</option>';
                    $.each(data, function (i, hall) {
                        options += `<option value="${hall.hallId}">${hall.name}</option>`;
                    });

                    $('#hallSelect').html(options).prop('disabled', false);
                    loadShowTimes(1); // Reset to Page 1
                });
            });

            // Hall or Date change -> Reload and Reset to Page 1
        $('#hallSelect, #dateSelect, #movieSelect').on('change', function() {
                loadShowTimes(1);
            });

            // Row checkbox logic
            $(document).on('change', '.row-check', function () {
                $('#deleteSelectedBtn').prop(
                    'disabled',
                    $('.row-check:checked').length === 0
                );
            });

            // Check all logic
            $(document).on('change', '#checkAll', function () {
                $('.row-check').prop('checked', this.checked);
                $('#deleteSelectedBtn').prop('disabled', !this.checked);
            });

            // ===============================
            // SINGLE DELETE (AJAX)
            // ===============================
            $(document).on('click', '.single-delete', function () {
                if (!confirm('Are you sure you want to delete this showtime?'))
                    return;

                let id = $(this).data('id');

                $.post('@Url.Action("DeleteShowTime")', {
                    id: id,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                })
                .done(function (res) {
                    if (res.success) {
                        alert(res.message);
                        // Reload the CURRENT page (so you don't jump back to page 1 after delete)
                        loadShowTimes(currentPage);
                    } else {
                        alert(res.message || 'Delete failed');
                    }
                })
                .fail(function (xhr) {
                    alert('Delete failed: ' + xhr.status);
                });
            });

        });
    </script>
}
