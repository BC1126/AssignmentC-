@model ProductUpdateVM

@{
    ViewBag.Title = "Product | Update";
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>

<form class="product-form" method="post" enctype="multipart/form-data">

    <div class="product-back">
        <button type="button" data-get="/Product/Index" aria-label="Back">←</button>
    </div>

    <h2>Update Product</h2>

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <input asp-for="Id" type="hidden" />

    <div class="product-grid">

        <div>
            <label>Id</label>
            <b>@Model.Id</b>
        </div>

        <div>
            <label asp-for="Name"></label>
            <input asp-for="Name" autofocus>
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>

        <div style="grid-column: span 2;">
            <label asp-for="Description"></label>
            <textarea asp-for="Description"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Price"></label>
            <input asp-for="Price" type="number" step="0.01">
            <span asp-validation-for="Price" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Stock"></label>
            <input asp-for="Stock" type="number">
            <span asp-validation-for="Stock" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Region"></label>
            <select asp-for="Region" id="region">
                <option value="">-- Select Region --</option>
                @foreach (var r in ViewBag.Regions)
                {
                    <option value="@r">@r</option>
                }
            </select>
            <span asp-validation-for="Region" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Cinema"></label>
            <select asp-for="Cinema" id="cinema">
                <option value="">-- Select Cinema --</option>
            </select>
            <span asp-validation-for="Cinema" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Category"></label>
            <select asp-for="Category">
                <option value="">-- Select Category --</option>
                @foreach (var c in ViewBag.Categories)
                {
                    <option value="@c">@c</option>
                }
            </select>
            <span asp-validation-for="Category" class="text-danger"></span>
        </div>

        <div>
            <label asp-for="Photo"></label>
            <label class="product-upload">
                <input asp-for="Photo" accept="image/jpeg,image/png" hidden>
                <img src="@Model.PhotoURL" id="photoPreview">
                <small>Click to upload</small>
            </label>
            <span asp-validation-for="Photo" class="text-danger"></span>
        </div>

    </div>

    <div class="product-actions">
        <button type="submit">Update</button>
        <button type="reset" id="resetBtn">Reset</button>
    </div>
</form>

@section foot {
    <script>
        $.validator.setDefaults({ ignore: '' });

        // photo preview
        document.querySelector('input[type="file"]').addEventListener('change', function () {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('photoPreview').src = e.target.result;
            reader.readAsDataURL(this.files[0]);
        });

        const regionDropdown = document.getElementById('region');
        const cinemaDropdown = document.getElementById('cinema');

        function loadCinemas(region, selectedCinema) {
            if (!region) {
                cinemaDropdown.innerHTML = '<option value="">-- Select Cinema --</option>';
                return;
            }

            $.get('@Url.Action("GetCinemas", "Product")', { region }, function (data) {
                cinemaDropdown.innerHTML = '<option value="">-- Select Cinema --</option>';
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.text = c.name;
                    if (c.name === selectedCinema) opt.selected = true;
                    cinemaDropdown.appendChild(opt);
                });
            });
        }

        // region change
        regionDropdown.addEventListener('change', function () {
            loadCinemas(this.value, null);
        });

        // load cinemas on page load
        loadCinemas('@Model.Region', '@Model.Cinema');
    </script>
}
