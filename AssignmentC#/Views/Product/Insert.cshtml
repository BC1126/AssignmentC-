@model ProductInsertVM

@{
    ViewBag.Title = "Product | Insert";
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>

<form class="form" method="post" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly"></div>

    <label asp-for="Id"></label>
    <input asp-for="Id" autofocus data-upper>
    <span asp-validation-for="Id"></span>

    <label asp-for="Name"></label>
    <input asp-for="Name">
    <span asp-validation-for="Name"></span>

    <label asp-for="Description"></label>
    <textarea asp-for="Description"></textarea>
    <span asp-validation-for="Description"></span>

    <label asp-for="Price"></label>
    <input asp-for="Price" type="number" step="0.01">
    <span asp-validation-for="Price"></span>

    <label asp-for="Stock"></label>
    <input asp-for="Stock" type="number">
    <span asp-validation-for="Stock"></span>

    <!-- Region Dropdown -->
    <label asp-for="Region"></label>
    <select asp-for="Region" id="region" class="form-control">
        <option value="">-- Select Region --</option>
        @foreach (var r in ViewBag.Regions)
        {
            <option value="@r">@r</option>
        }
    </select>
    <span asp-validation-for="Region"></span>

    <!-- Cinema Dropdown -->
    <label asp-for="Cinema"></label>
    <select asp-for="Cinema" id="cinema" class="form-control">
        <option value="">-- Select Cinema --</option>
    </select>
    <span asp-validation-for="Cinema"></span>

    <!-- Category Dropdown -->
    <label asp-for="Category"></label>
    <select asp-for="Category" class="form-control">
        <option value="">-- Select Category --</option>
        @foreach (var c in ViewBag.Categories)
        {
            <option value="@c">@c</option>
        }
    </select>
    <span asp-validation-for="Category"></span>

    <!-- Photo Upload -->
    <label asp-for="Photo"></label>
    <label class="upload">
        <input asp-for="Photo" accept="image/jpeg,image/png" hidden>
        <img src="/images/photo.jpg" id="photoPreview" style="max-width:150px;">
    </label>
    <span asp-validation-for="Photo"></span>

    <section>
        <button type="submit">Submit</button>
        <button type="reset" id="resetBtn">Reset</button>
    </section>
</form>

@section foot {
    <script>
        $.validator.setDefaults({ ignore: '' });

        // Photo preview
        document.querySelector('input[type="file"]').addEventListener('change', function () {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('photoPreview').src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
        });

        const regionDropdown = document.getElementById('region');
        const cinemaDropdown = document.getElementById('cinema');

        // AJAX load cinemas by selected region
        function loadCinemas(region) {
            if (!region) {
                cinemaDropdown.innerHTML = '<option value="">-- Select Cinema --</option>';
                return;
            }

            $.ajax({
                url: '@Url.Action("GetCinemas", "Product")',
                type: 'GET',
                data: { region: region },
                success: function (data) {
                    console.log("Returned cinemas:", data);
                    cinemaDropdown.innerHTML = '<option value="">-- Select Cinema --</option>';

                    data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.name;  // lowercase to match controller JSON
                        opt.text = c.name;
                        cinemaDropdown.appendChild(opt);
                    });
                },
                error: function () {
                    alert('Failed to load cinemas.');
                }
            });
        }

        // On region change
        regionDropdown.addEventListener('change', function () {
            loadCinemas(this.value);
        });

        // Reset button clears cinema dropdown
        document.getElementById('resetBtn').addEventListener('click', function () {
            cinemaDropdown.innerHTML = '<option value="">-- Select Cinema --</option>';
        });

        // Load cinemas for default region on page load
        if (regionDropdown.value) {
            loadCinemas(regionDropdown.value);
        }
    </script>
}
