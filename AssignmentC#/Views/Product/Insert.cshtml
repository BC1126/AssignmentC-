@model ProductInsertVM

@{
    ViewBag.Title = "Product | Insert";
}

<form class="form" method="post" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly"></div>

    <label asp-for="Id"></label>
    <input asp-for="Id" autofocus data-upper>
    <span asp-validation-for="Id"></span>

    <label asp-for="Name"></label>
    <input asp-for="Name">
    <span asp-validation-for="Name"></span>

    <label asp-for="Description"></label>
    <textarea asp-for="Description"></textarea>
    <span asp-validation-for="Description"></span>

    <label asp-for="Price"></label>
    <input asp-for="Price" type="number" step="0.01">
    <span asp-validation-for="Price"></span>

    <label asp-for="Stock"></label>
    <input asp-for="Stock" type="number">
    <span asp-validation-for="Stock"></span>

    <!-- Region Dropdown -->
    <label asp-for="Region"></label>
    <select asp-for="Region" id="region" class="form-control">
        <option value="">-- Select Region --</option>
        @foreach (var r in ViewBag.Regions)
        {
            <option value="@r">@r</option>
        }
    </select>
    <span asp-validation-for="Region"></span>

    <!-- Cinema Dropdown -->
    <label asp-for="Cinema"></label>
    <select asp-for="Cinema" id="cinema" class="form-control">
        <option value="">-- Select Cinema --</option>
        @foreach (var c in ViewBag.Cinemas)
        {
            <option value="@c.Name" data-region="@c.City">@c.Name</option>
        }
    </select>
    <span asp-validation-for="Cinema"></span>

    <!-- Category Dropdown -->
    <label asp-for="Category"></label>
    <select asp-for="Category" class="form-control">
        <option value="">-- Select Category --</option>
        @foreach (var c in ViewBag.Categories)
        {
            <option value="@c">@c</option>
        }
    </select>
    <span asp-validation-for="Category"></span>

    <label asp-for="Photo"></label>
    <label class="upload">
        <input asp-for="Photo" accept="image/jpeg,image/png" hidden>
        <img src="/images/photo.jpg" id="photoPreview">
    </label>
    <span asp-validation-for="Photo"></span>

    <section>
        <button type="submit">Submit</button>
        <button type="reset">Reset</button>
    </section>
</form>

@section foot {
    <script>
        $.validator.setDefaults({ ignore: '' });

        // Photo preview
        document.querySelector('input[type="file"]').addEventListener('change', function (e) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('photoPreview').src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
        });

        // Cascading dropdown: Region -> Cinema
        const regionDropdown = document.getElementById('region');
        const cinemaDropdown = document.getElementById('cinema');

        function filterCinemas() {
            const selectedRegion = regionDropdown.value;

            for (let i = 0; i < cinemaDropdown.options.length; i++) {
                const option = cinemaDropdown.options[i];
                const region = option.getAttribute('data-region');

                if (!region || region === selectedRegion) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            }

            if (cinemaDropdown.selectedOptions.length > 0 &&
                cinemaDropdown.selectedOptions[0].style.display === 'none') {
                cinemaDropdown.value = '';
            }
        }

        // On page load & region change
        filterCinemas();
        regionDropdown.addEventListener('change', filterCinemas);
    </script>
}
