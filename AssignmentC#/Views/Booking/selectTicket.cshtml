@model SelectTicketViewModel
@{
    ViewData["Title"] = "Select Seats - " + Model.MovieTitle;
}
@section head {
    <link rel="stylesheet" href="~/css/selectTicket.css" />
}

<section id="content">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>@Model.MovieTitle</h2>
                <p class="text-muted">
                    @Model.HallName - @Model.OutletName<br>
                    @Model.StartTime.ToString("dddd, MMMM dd, yyyy - h:mm tt")<br>
                    Price: RM @Model.TicketPrice per seat
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-controller="Seed" asp-action="TestBooking" class="btn btn-secondary">
                    ⬅ Back to Showtimes
                </a>
            </div>
        </div>

        <ul class="showcase">
            <li><div class="seat-legend"></div><small>Available</small></li>
            <li><div class="seat-legend selected"></div><small>Selected</small></li>
            <li><div class="seat-legend occupied"></div><small>Occupied</small></li>
            <li><div class="seat-legend vip"></div><small>VIP</small></li>
            <li><div class="seat-legend wheelchair"></div><small>Wheelchair</small></li>
        </ul>

        <div class="screen">SCREEN</div>

        <div id="seat-map">
            @{
                var groupedSeats = Model.Seats.GroupBy(s => s.Row).OrderBy(g => g.Key);
            }
            @foreach (var rowGroup in groupedSeats)
            {
                <div class="seat-row">
                    <span class="row-label">@rowGroup.Key</span>
                    @foreach (var seat in rowGroup.OrderBy(s => s.Column))
                    {
                        var seatClass = "seat";

                        if (seat.IsOccupied)
                        {
                            seatClass += " occupied";
                        }
                        else if (seat.IsPremium)
                        {
                            seatClass += " vip";
                        }
                        else if (seat.IsWheelchair)
                        {
                            seatClass += " wheelchair";
                        }

                        <div class="@seatClass"
                             data-seat-id="@seat.SeatId"
                             data-identifier="@seat.SeatIdentifier"
                             data-row="@seat.Row"
                             data-column="@seat.Column">
                            @seat.SeatIdentifier
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Form to submit selected seats -->
        <form asp-action="SelectTicket" method="post" id="seatForm">
            <input type="hidden" name="showTimeId" value="@Model.ShowTimeId" />
            <div id="seatIdsContainer"></div>

            <div class="booking-summary card p-4 mt-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-1">
                            You have selected <strong><span id="count">0</span></strong> seats
                        </p>
                        <p class="mb-0">
                            Total: <strong>RM <span id="total">0</span></strong>
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Next    →
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section foot {
    <script>
        const ticketPrice = @Model.TicketPrice;
        const seatMap = document.getElementById("seat-map");
        const count = document.getElementById("count");
        const total = document.getElementById("total");
        const seatForm = document.getElementById("seatForm");
        const seatIdsContainer = document.getElementById("seatIdsContainer");

        function updateSelectedCount() {
            const selectedSeats = document.querySelectorAll("#seat-map .seat.selected");
            count.innerText = selectedSeats.length;
            total.innerText = (selectedSeats.length * ticketPrice).toFixed(2);
        }

        // Seat selection
        seatMap.addEventListener("click", e => {
            if (e.target.classList.contains("seat") &&
                !e.target.classList.contains("occupied")) {
                e.target.classList.toggle("selected");
                updateSelectedCount();
            }
        });

        // Form submission - create hidden inputs for each seat ID
        seatForm.addEventListener("submit", e => {
            const selectedSeats = [...document.querySelectorAll("#seat-map .seat.selected")];

            if (selectedSeats.length === 0) {
                e.preventDefault();
                alert("Please select at least one seat");
                return;
            }

            // Clear previous inputs
            seatIdsContainer.innerHTML = "";

            // Create a separate hidden input for each seat ID
            // This is how ASP.NET Core binds to List<int>
            selectedSeats.forEach(seat => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "seatIds";  // Same name for all = binds to List
                input.value = seat.dataset.seatId;
                seatIdsContainer.appendChild(input);
            });
        });

        updateSelectedCount();
    </script>
}