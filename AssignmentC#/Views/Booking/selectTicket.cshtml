@model SelectTicketViewModel
@{
    ViewData["Title"] = "Select Seats - " + Model.MovieTitle;
}
@section head {
    <link rel="stylesheet" href="~/css/selectTicket.css" />
}

<section id="content">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>@Model.MovieTitle</h2>
                <p class="text-muted">
                    @Model.HallName - @Model.OutletName<br>
                    @Model.StartTime.ToString("dddd, MMMM dd, yyyy - h:mm tt")<br>
                    Price: RM @Model.TicketPrice per seat
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-controller="Seed" asp-action="TestBooking" class="btn btn-secondary">
                    ⬅ Back to Showtimes
                </a>
            </div>
        </div>

        <ul class="showcase">
            <li><div class="seat-legend"></div><small>Available</small></li>
            <li><div class="seat-legend selected"></div><small>Selected</small></li>
            <li><div class="seat-legend occupied"></div><small>Occupied</small></li>
            <li><div class="seat-legend vip"></div><small>VIP</small></li>
            <li><div class="seat-legend wheelchair"></div><small>Wheelchair</small></li>
        </ul>

        <div class="screen">SCREEN</div>

        <div id="seat-map">
            @{
                var groupedSeats = Model.Seats.GroupBy(s => s.Row).OrderBy(g => g.Key);
            }
            @foreach (var rowGroup in groupedSeats)
            {
                <div class="seat-row">
                    <span class="row-label">@rowGroup.Key</span>
                    @foreach (var seat in rowGroup.OrderBy(s => s.Column))
                    {
                        var seatClass = "seat";

                        if (seat.IsOccupied)
                        {
                            seatClass += " occupied";
                        }
                        else if (seat.IsPremium)
                        {
                            seatClass += " vip";
                        }
                        else if (seat.IsWheelchair)
                        {
                            seatClass += " wheelchair";
                        }

                        <div class="@seatClass"
                             data-seat-id="@seat.SeatId"
                             data-identifier="@seat.SeatIdentifier"
                             data-row="@seat.Row"
                             data-column="@seat.Column">
                            @seat.SeatIdentifier
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Ticket Type Selection (appears after seat selection) -->
        <div id="ticketTypeSection" class="ticket-type-selector">
            <h5 class="mb-3">Select Ticket Types</h5>
            <p class="ticket-type-note">Total must equal <strong><span id="totalSeatsSelected">0</span></strong> selected seats</p>

            <div class="ticket-counter">
                <div class="ticket-counter-label">
                    Children (Age 3-12)
                    <small class="d-block text-muted">RM @Model.TicketPrice</small>
                </div>
                <div class="ticket-counter-controls">
                    <button type="button" class="counter-btn" onclick="changeCount('children', -1)">−</button>
                    <span class="counter-value" id="childrenCount">0</span>
                    <button type="button" class="counter-btn" onclick="changeCount('children', 1)">+</button>
                </div>
            </div>

            <div class="ticket-counter">
                <div class="ticket-counter-label">
                    Adults (Age 13-59)
                    <small class="d-block text-muted">RM @Model.TicketPrice</small>
                </div>
                <div class="ticket-counter-controls">
                    <button type="button" class="counter-btn" onclick="changeCount('adult', -1)">−</button>
                    <span class="counter-value" id="adultCount">0</span>
                    <button type="button" class="counter-btn" onclick="changeCount('adult', 1)">+</button>
                </div>
            </div>

            <div class="ticket-counter">
                <div class="ticket-counter-label">
                    Seniors (Age 60+)
                    <small class="d-block text-muted">RM @(Model.TicketPrice * 0.8m) (20% discount)</small>
                </div>
                <div class="ticket-counter-controls">
                    <button type="button" class="counter-btn" onclick="changeCount('senior', -1)">−</button>
                    <span class="counter-value" id="seniorCount">0</span>
                    <button type="button" class="counter-btn" onclick="changeCount('senior', 1)">+</button>
                </div>
            </div>

            <div class="alert alert-warning mt-3" id="ticketWarning" style="display: none;">
                <small>⚠️ Total ticket count must match the number of selected seats</small>
            </div>
        </div>

        <!-- Form to submit selected seats -->
        <form asp-action="SelectTicket" method="post" id="seatForm">
            <input type="hidden" name="showTimeId" value="@Model.ShowTimeId" />
            <div id="seatIdsContainer"></div>
            <input type="hidden" name="childrenCount" id="childrenCountInput" value="0" />
            <input type="hidden" name="adultCount" id="adultCountInput" value="0" />
            <input type="hidden" name="seniorCount" id="seniorCountInput" value="0" />

            <div class="booking-summary card p-4 mt-4">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-1">
                            You have selected <strong><span id="count">0</span></strong> seats
                        </p>
                        <p class="mb-0">
                            Total: <strong>RM <span id="total">0</span></strong>
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="submit" class="btn btn-primary btn-lg" id="nextButton">
                            Next →
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section foot {
    <script>
        const ticketPrice = @Model.TicketPrice;
        const seniorPrice = @(Model.TicketPrice * 0.8m);
        const seatMap = document.getElementById("seat-map");
        const count = document.getElementById("count");
        const total = document.getElementById("total");

        let childrenCount = 0;
        let adultCount = 0;
        let seniorCount = 0;
        let selectedSeatsCount = 0;

        function updateSelectedCount() {
            const selectedSeats = document.querySelectorAll("#seat-map .seat.selected");
            const previousCount = selectedSeatsCount;
            selectedSeatsCount = selectedSeats.length;
            count.innerText = selectedSeatsCount;

            // Show/hide ticket type section
            if (selectedSeatsCount > 0) {
                ticketTypeSection.style.display = "block";
                document.getElementById("totalSeatsSelected").innerText = selectedSeatsCount;

                // Auto-adjust adult count when seat count changes
                const difference = selectedSeatsCount - previousCount;
                adultCount += difference;
                if (adultCount < 0) adultCount = 0;

                updateCountDisplay();
            } else {
                ticketTypeSection.style.display = "none";
                resetCounts();
            }

            updateTotal();
            validateTicketCounts();
        }

        function changeCount(type, delta) {
            const totalTickets = childrenCount + adultCount + seniorCount;

            if (type === 'children') {
                const newCount = childrenCount + delta;
                if (newCount >= 0 && totalTickets + delta <= selectedSeatsCount) {
                    childrenCount = newCount;
                }
            } else if (type === 'adult') {
                const newCount = adultCount + delta;
                if (newCount >= 0 && totalTickets + delta <= selectedSeatsCount) {
                    adultCount = newCount;
                }
            } else if (type === 'senior') {
                const newCount = seniorCount + delta;
                if (newCount >= 0 && totalTickets + delta <= selectedSeatsCount) {
                    seniorCount = newCount;
                }
            }

            updateCountDisplay();
            updateTotal();
            validateTicketCounts();
        }

        function updateCountDisplay() {
            document.getElementById("childrenCount").innerText = childrenCount;
            document.getElementById("adultCount").innerText = adultCount;
            document.getElementById("seniorCount").innerText = seniorCount;

            document.getElementById("childrenCountInput").value = childrenCount;
            document.getElementById("adultCountInput").value = adultCount;
            document.getElementById("seniorCountInput").value = seniorCount;
        }

        function updateTotal() {
            const totalAmount = (childrenCount * ticketPrice) +
                               (adultCount * ticketPrice) +
                               (seniorCount * seniorPrice);
            total.innerText = totalAmount.toFixed(2);
        }

        function validateTicketCounts() {
            const totalTickets = childrenCount + adultCount + seniorCount;
            const isValid = totalTickets === selectedSeatsCount && selectedSeatsCount > 0;

            if (selectedSeatsCount > 0 && totalTickets !== selectedSeatsCount) {
                ticketWarning.style.display = "block";
                nextButton.disabled = true;
            } else {
                ticketWarning.style.display = "none";
                nextButton.disabled = false;
            }
        }

        function resetCounts() {
            childrenCount = 0;
            adultCount = 0;
            seniorCount = 0;
            updateCountDisplay();
        }

        // Seat selection
        seatMap.addEventListener("click", e => {
            if (e.target.classList.contains("seat") &&
                !e.target.classList.contains("occupied")) {
                e.target.classList.toggle("selected");
                updateSelectedCount();
            }
        });

        // Form submission - create hidden inputs for each seat ID
        seatForm.addEventListener("submit", e => {
            const selectedSeats = [...document.querySelectorAll("#seat-map .seat.selected")];

            if (selectedSeats.length === 0) {
                e.preventDefault();
                alert("Please select at least one seat");
                return;
            }

            // Get seat IDs and validate
            const seatIds = [];
            let hasInvalidSeats = false;

            selectedSeats.forEach(s => {
                const seatIdStr = s.dataset.seatId;
                const identifier = s.dataset.identifier;

                if (!seatIdStr || seatIdStr === "0" || seatIdStr === "") {
                    console.error(`Invalid seat ID for ${identifier}:`, seatIdStr);
                    hasInvalidSeats = true;
                    return;
                }

                const id = parseInt(seatIdStr);
                if (isNaN(id) || id === 0) {
                    console.error(`Failed to parse seat ID for ${identifier}:`, seatIdStr);
                    hasInvalidSeats = true;
                    return;
                }

                seatIds.push(id);
            });

            if (hasInvalidSeats || seatIds.length === 0) {
                alert("Error: Invalid seat selection. Please refresh the page and try again.");
                return;
            }

            const requestData = {
                showTimeId: showTimeId,
                seatIds: seatIds
            };

            try {
                const response = await fetch("/Booking/AddToCart", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Server error:", errorText);
                    alert("Server error: " + response.status);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    window.location.href = "/Cart";
                } else {
                    alert(result.message || "Failed to add to cart");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred: " + error.message);
            }
        });

        updateSelectedCount();
    </script>
}