@model SelectTicketViewModel
@{
    ViewData["Title"] = "Select Seats - " + Model.MovieTitle;
}
@section head {
    <link rel="stylesheet" href="~/css/selectTicket.css" />
}


<section id="content">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>@Model.MovieTitle</h2>
                <p class="text-muted">
                    @Model.HallName - @Model.OutletName<br>
                    @Model.StartTime.ToString("dddd, MMMM dd, yyyy - h:mm tt")<br>
                    Price: RM @Model.TicketPrice per seat
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-controller="Booking"
                   asp-action="selectShowtime"
                   asp-route-movieId="@Model.MovieId" class="btn btn-secondary">
                    ⬅ Back to Showtimes
                </a>
            </div>
        </div>

        <ul class="showcase">
            <li><div class="seat-legend"></div><small>Available</small></li>
            <li><div class="seat-legend selected"></div><small>Selected</small></li>
            <li><div class="seat-legend occupied"></div><small>Occupied</small></li>
            <li><div class="seat-legend locked"></div><small>Being Held</small></li>
            <li><div class="seat-legend vip"></div><small>VIP</small></li>
            <li><div class="seat-legend wheelchair"></div><small>Wheelchair</small></li>
        </ul>

        <div class="screen">SCREEN</div>

        <div id="seat-map">
            @{
                var groupedSeats = Model.Seats.GroupBy(s => s.Row).OrderBy(g => g.Key);
            }
            @foreach (var rowGroup in groupedSeats)
            {
                <div class="seat-row">
                    <span class="row-label">@rowGroup.Key</span>
                    @foreach (var seat in rowGroup.OrderBy(s => s.Column))
                    {
                        var seatClass = "seat";

                        if (seat.IsOccupied)
                        {
                            seatClass += " occupied";
                        }
                        else if (seat.IsLocked)
                        {
                            seatClass += " locked";
                        }
                        else if (seat.IsPremium)
                        {
                            seatClass += " vip";
                        }
                        else if (seat.IsWheelchair)
                        {
                            seatClass += " wheelchair";
                        }
                        else if (seat.IsSelected) seatClass += " selected";
                            
                        <div class="@seatClass"
                             data-seat-id="@seat.SeatId"
                             data-identifier="@seat.SeatIdentifier">
                            @seat.SeatIdentifier
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Wrapper for side-by-side layout -->
        <div class="booking-sections-wrapper">

            <!-- Ticket Type Selection (LEFT SIDE) -->
            <div id="ticketTypeSection" class="ticket-type-selector" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Select Ticket Types</h5>
                    <div id="seatTimer" class="seat-timer" style="display: none;">
                        <i class="bi bi-clock"></i> <span id="timerDisplay">5:00</span>
                    </div>
                </div>
                <p class="ticket-type-note">Total: <strong><span id="totalSeatsSelected">0</span></strong> seats selected</p>

                <div class="ticket-counter" data-ticket-type="children">
                    <div class="ticket-counter-label">
                        <div>Children (3-12)</div>
                        <small class="text-muted">RM @Model.ChildrenPrice.ToString("F2") <span style="color: #28a745;">(20% off)</span></small>
                    </div>
                    <div class="ticket-counter-controls">
                        <button type="button" class="counter-btn" data-action="decrement">−</button>
                        <span class="counter-value" data-count-display="children">0</span>
                        <button type="button" class="counter-btn" data-action="increment">+</button>
                    </div>
                </div>

                <div class="ticket-counter" data-ticket-type="adult">
                    <div class="ticket-counter-label">
                        <div>Adults (13-59)</div>
                        <small class="text-muted">RM @Model.TicketPrice</small>
                    </div>
                    <div class="ticket-counter-controls">
                        <button type="button" class="counter-btn" data-action="decrement">−</button>
                        <span class="counter-value" data-count-display="adult">0</span>
                        <button type="button" class="counter-btn" data-action="increment">+</button>
                    </div>
                </div>

                <div class="ticket-counter" data-ticket-type="senior">
                    <div class="ticket-counter-label">
                        <div>Seniors (60+)</div>
                        <small class="text-muted">RM @Model.SeniorPrice.ToString("F2") <span style="color: #28a745;">(15% off)</span></small>
                    </div>
                    <div class="ticket-counter-controls">
                        <button type="button" class="counter-btn" data-action="decrement">−</button>
                        <span class="counter-value" data-count-display="senior">0</span>
                        <button type="button" class="counter-btn" data-action="increment">+</button>
                    </div>
                </div>

                <div class="alert alert-warning mt-3" id="ticketWarning" style="display: none; font-size: 13px; padding: 8px;">
                    <small>⚠️ Total must match selected seats</small>
                </div>
            </div>

            <!-- Booking Summary (RIGHT SIDE) -->
            <form asp-action="SelectTicket"
                  method="post"
                  id="seatForm"
                  data-showtime-id="@Model.ShowTimeId"
                  data-ticket-price="@Model.TicketPrice"
                  data-children-price="@Model.ChildrenPrice.ToString("F2")"
                  data-senior-price="@Model.SeniorPrice.ToString("F2")"
                  data-lock-duration="@Model.LockDurationMinutes">

                @Html.AntiForgeryToken()

                <input type="hidden" name="ShowTimeId" value="@Model.ShowTimeId" />
                <div id="seatIdsContainer"></div>
                <input type="hidden" name="ChildrenCount" data-count-input="children" value="0" />
                <input type="hidden" name="AdultCount" data-count-input="adult" value="0" />
                <input type="hidden" name="SeniorCount" data-count-input="senior" value="0" />

                <div class="booking-summary card p-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1">
                                Selected: <strong><span id="count">0</span></strong> seats
                            </p>
                            <p class="mb-0">
                                Total: <strong>RM <span id="total">0.00</span></strong>
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="submit" class="btn btn-primary btn-lg" id="nextButton" disabled>
                                Next →
                            </button>
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</section>

@section foot {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/selectTicket.js"></script>
}